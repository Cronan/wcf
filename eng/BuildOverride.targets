<?xml version="1.0" encoding="utf-8"?>
<Project>

  <!--<PropertyGroup>
    <TestCleanupDependsOn>
      $(TestCleanupDependsOn);
      Test;
      WcfCleanup;
    </TestCleanupDependsOn>
    <CompileDependsOn>
      $(CompileDependsOn);
      WcfSetup;
    </CompileDependsOn>
  </PropertyGroup>-->

  <PropertyGroup>
    <WcfSelfHostSetupLog>$(MSBuildThisFileDirectory)\SelfHostedWcfServiceSetup.log</WcfSelfHostSetupLog>
    <WcfSelfHostCleanupLog>$(MSBuildThisFileDirectory)\SelfHostedWcfServiceCleanup.log</WcfSelfHostCleanupLog>
  </PropertyGroup>

  <!--if ServiceUri is set, the service has been already started on another machine-->
  <Target Name="WcfSetup" BeforeTargets="BeforeCompile" Condition="($(IsIntegrationTestProject) == 'true') and ('$(ServiceUri)' == '') and $(OS) == 'Windows_NT'" >
    <Delete Files="$(WcfSelfHostSetupLog)" Condition="Exists('$(WcfSelfHostSetupLog)')" />
    <Exec Command="$(MSBuildThisFileDirectory)\..\src\System.Private.ServiceModel\tools\scripts\StartWCFSelfHostedSvc.cmd" ContinueOnError="true">
      <Output TaskParameter="ExitCode" PropertyName="WcfSetupErrorCode"/>
    </Exec>
    <Message Text="WcfSetupErrorCode: $(WcfSetupErrorCode)" />

    <!-- Log the console output generated by the scripts we invoked -->
    <Message Text="-------------- WCF self-host outerloop setup start --------------" Importance="High" />
    <Message Text="$([System.IO.File]::ReadAllText($(WcfSelfHostSetupLog)))" Condition="Exists('$(WcfSelfHostSetupLog)')" Importance="High"/>
    <Message Text="-------------- WCF self-host outerloop setup end --------------" Importance="High"/>
  </Target>

  <Target Name="WcfCleanUp" Condition="$(WcfSetupErrorCode)!='-1' and $(WcfSetupErrorCode)!=''" >
    <Message Text="-------------- WCF self-host outerloop cleanup start --------------" Importance="High" />
    <Delete Files="$(WcfSelfHostCleanupLog)" Condition="Exists('$(WcfSelfHostCleanupLog)')" />
    <Exec Command="$(MSBuildThisFileDirectory)\src\System.Private.ServiceModel\tools\scripts\StopWcfSelfHostedSvc.cmd" ContinueOnError="true" />
    <Message Text="$([System.IO.File]::ReadAllText($(WcfSelfHostCleanupLog)))" Condition="Exists('$(WcfSelfHostCleanupLog)')" Importance="High" />
    <Message Text="-------------- WCF self-host outerloop cleanup end --------------" Importance="High" />
  </Target>
</Project>
